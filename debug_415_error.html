<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Debug 415 Error</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        button { margin: 10px; padding: 10px; font-size: 16px; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>Debug 415 Error - Cibozer API</h1>
    
    <p>Open the browser console (F12) to see detailed logs</p>
    
    <div>
        <button onclick="testSimple()">1. Test Simple JSON</button>
        <button onclick="testWithCSRF()">2. Test with CSRF Token</button>
        <button onclick="testWithCookies()">3. Test with Cookies</button>
        <button onclick="testActualGenerate()">4. Test Actual Generate</button>
    </div>
    
    <h2>Results:</h2>
    <pre id="results"></pre>
    
    <script>
    const resultsEl = document.getElementById('results');
    
    function log(msg, type = '') {
        const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
        const className = type ? ` class="${type}"` : '';
        resultsEl.innerHTML += `<span${className}>[${timestamp}] ${msg}</span>\n`;
        console.log(msg);
    }
    
    function logHeaders(headers) {
        const h = {};
        headers.forEach((value, key) => {
            h[key] = value;
        });
        return JSON.stringify(h, null, 2);
    }
    
    async function testSimple() {
        log('\n=== Test 1: Simple JSON Request ===');
        
        const data = { test: 'simple', value: 123 };
        log('Request data: ' + JSON.stringify(data));
        
        try {
            const response = await fetch('/api/test-json', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            log(`Response status: ${response.status} ${response.statusText}`, 
                response.ok ? 'success' : 'error');
            log('Response headers: ' + logHeaders(response.headers));
            
            const text = await response.text();
            log('Response body: ' + text);
            
            if (response.ok) {
                const json = JSON.parse(text);
                log('Parsed response: ' + JSON.stringify(json, null, 2), 'success');
            }
        } catch (error) {
            log('ERROR: ' + error.message, 'error');
            console.error(error);
        }
    }
    
    async function testWithCSRF() {
        log('\n=== Test 2: JSON Request with CSRF Token ===');
        
        // Try to get CSRF token from meta tag
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = csrfMeta ? csrfMeta.content : 'no-csrf-token-found';
        log('CSRF Token: ' + csrfToken);
        
        const data = { test: 'with-csrf', value: 456 };
        
        try {
            const response = await fetch('/api/test-json', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(data)
            });
            
            log(`Response status: ${response.status} ${response.statusText}`, 
                response.ok ? 'success' : 'error');
            
            const text = await response.text();
            log('Response body: ' + text);
        } catch (error) {
            log('ERROR: ' + error.message, 'error');
        }
    }
    
    async function testWithCookies() {
        log('\n=== Test 3: JSON Request with Credentials ===');
        
        const data = { test: 'with-cookies', value: 789 };
        
        try {
            const response = await fetch('/api/test-json', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            });
            
            log(`Response status: ${response.status} ${response.statusText}`, 
                response.ok ? 'success' : 'error');
            
            const text = await response.text();
            log('Response body: ' + text);
        } catch (error) {
            log('ERROR: ' + error.message, 'error');
        }
    }
    
    async function testActualGenerate() {
        log('\n=== Test 4: Actual /api/generate Endpoint ===');
        
        const data = {
            calories: "2000",
            days: "1",
            diet: "standard",
            meal_structure: "standard"
        };
        
        log('Request data: ' + JSON.stringify(data));
        
        try {
            const response = await fetch('/api/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify(data)
            });
            
            log(`Response status: ${response.status} ${response.statusText}`, 
                response.ok ? 'success' : 'error');
            
            const text = await response.text();
            log('Response body (first 500 chars): ' + text.substring(0, 500));
            
            if (response.status === 415) {
                log('\n🔍 415 ERROR DETECTED! This is the issue we need to fix.', 'error');
                log('The server is rejecting our JSON request.', 'error');
            }
        } catch (error) {
            log('ERROR: ' + error.message, 'error');
        }
    }
    
    // Log browser info on load
    window.addEventListener('load', () => {
        log('Browser: ' + navigator.userAgent);
        log('Ready to test. Click the buttons above.');
    });
    </script>
</body>
</html>