{% extends "base.html" %}

{% block title %}Monitoring Dashboard - Cibozer{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.metric-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.metric-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.metric-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.health-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}

.health-healthy { background-color: #28a745; }
.health-warning { background-color: #ffc107; }
.health-critical { background-color: #dc3545; }

.chart-container {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.alert-item {
    border-left: 4px solid;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-radius: 0 5px 5px 0;
}

.alert-critical { border-color: #dc3545; background-color: #f8d7da; }
.alert-warning { border-color: #ffc107; background-color: #fff3cd; }
.alert-info { border-color: #17a2b8; background-color: #d1ecf1; }

.refresh-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #28a745;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    opacity: 0;
    transition: opacity 0.3s;
}

.refresh-indicator.show {
    opacity: 1;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-chart-line"></i> Monitoring Dashboard</h1>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
            <span class="text-muted small">Last updated: <span id="last-updated">{{ data.timestamp }}</span></span>
        </div>
    </div>

    <!-- Overview Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ data.overview.requests_last_hour }}</div>
                <div class="metric-label">
                    <i class="fas fa-globe"></i> Requests (Last Hour)
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ data.overview.errors_last_hour }}</div>
                <div class="metric-label">
                    <i class="fas fa-exclamation-triangle"></i> Errors (Last Hour)
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ "%.2f"|format(data.overview.error_rate_percent) }}%</div>
                <div class="metric-label">
                    <i class="fas fa-percentage"></i> Error Rate
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card">
                <div class="metric-value">{{ "%.0f"|format(data.overview.avg_response_time_ms) }}ms</div>
                <div class="metric-label">
                    <i class="fas fa-clock"></i> Avg Response Time
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Health Status -->
        <div class="col-md-6">
            <div class="chart-container">
                <h4><i class="fas fa-heartbeat"></i> System Health</h4>
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="h5">Overall Status</span>
                        <span class="badge {{ 'bg-success' if data.health.healthy else 'bg-danger' }}">
                            {{ 'Healthy' if data.health.healthy else 'Unhealthy' }}
                        </span>
                    </div>

                    {% for check_name, check_data in data.health.checks.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded" 
                         style="background-color: #f8f9fa;">
                        <div>
                            <span class="health-indicator {{ 'health-healthy' if check_data.healthy else 'health-critical' }}"></span>
                            <strong>{{ check_name.replace('_', ' ').title() }}</strong>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">{{ check_data.message }}</small><br>
                            <small class="text-muted">{{ "%.1f"|format(check_data.duration_ms) }}ms</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="col-md-6">
            <div class="chart-container">
                <h4><i class="fas fa-tachometer-alt"></i> Performance</h4>
                <canvas id="performanceChart" height="200"></canvas>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Error Summary -->
        <div class="col-md-6">
            <div class="chart-container">
                <h4><i class="fas fa-bug"></i> Error Summary (24h)</h4>
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h3 text-danger">{{ data.errors.total_errors }}</div>
                            <small class="text-muted">Total Errors</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h3 text-warning">{{ "%.2f"|format(data.errors.error_rate) }}</div>
                            <small class="text-muted">Errors/Hour</small>
                        </div>
                    </div>
                </div>

                {% if data.errors.error_types %}
                <div class="mt-3">
                    <h6>Error Types</h6>
                    {% for error_type, count in data.errors.error_types.items() %}
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span>{{ error_type }}</span>
                        <span class="badge bg-danger">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Alerts -->
        <div class="col-md-6">
            <div class="chart-container">
                <h4><i class="fas fa-bell"></i> Recent Alerts</h4>
                {% if data.alerts %}
                    {% for alert in data.alerts %}
                    <div class="alert-item alert-{{ alert.severity }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>{{ alert.name }}</strong>
                                <p class="mb-1 small">{{ alert.condition }}</p>
                                <small class="text-muted">{{ alert.timestamp }}</small>
                            </div>
                            <div class="badge bg-{{ 'danger' if alert.severity == 'critical' else 'warning' if alert.severity == 'warning' else 'info' }}">
                                {{ alert.severity }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <p>No recent alerts</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- System Metrics -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container">
                <h4><i class="fas fa-server"></i> System Metrics</h4>
                <div class="row" id="system-metrics">
                    <div class="col-md-4">
                        <canvas id="cpuChart" height="150"></canvas>
                    </div>
                    <div class="col-md-4">
                        <canvas id="memoryChart" height="150"></canvas>
                    </div>
                    <div class="col-md-4">
                        <canvas id="diskChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Refresh Indicator -->
<div id="refresh-indicator" class="refresh-indicator">
    <i class="fas fa-sync-alt"></i> Updated
</div>

<script>
// Dashboard data
let dashboardData = {{ data | tojson }};
let charts = {};

// Initialize charts on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    loadSystemMetrics();
    
    // Auto-refresh every 30 seconds
    setInterval(refreshDashboard, 30000);
});

function initializeCharts() {
    // Performance Chart
    const performanceCtx = document.getElementById('performanceChart').getContext('2d');
    const perfData = dashboardData.performance;
    
    charts.performance = new Chart(performanceCtx, {
        type: 'bar',
        data: {
            labels: ['Count', 'Min', 'Mean', 'Max', 'P95', 'P99'],
            datasets: [{
                label: 'Response Time (ms)',
                data: [
                    perfData.count || 0,
                    perfData.min || 0,
                    perfData.mean || 0,
                    perfData.max || 0,
                    perfData.p95 || 0,
                    perfData.p99 || 0
                ],
                backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545', '#fd7e14', '#6610f2'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Milliseconds'
                    }
                }
            }
        }
    });
}

function loadSystemMetrics() {
    fetch('/monitoring/api/system')
        .then(response => response.json())
        .then(data => {
            createGaugeChart('cpuChart', 'CPU Usage', data.cpu_percent, '%');
            createGaugeChart('memoryChart', 'Memory Usage', data.memory_percent, '%');
            createGaugeChart('diskChart', 'Disk Usage', data.disk_percent, '%');
        })
        .catch(error => console.error('Error loading system metrics:', error));
}

function createGaugeChart(canvasId, title, value, unit) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    
    // Destroy existing chart if it exists
    if (charts[canvasId]) {
        charts[canvasId].destroy();
    }
    
    const color = value > 80 ? '#dc3545' : value > 60 ? '#ffc107' : '#28a745';
    
    charts[canvasId] = new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [value, 100 - value],
                backgroundColor: [color, '#e9ecef'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            circumference: 180,
            rotation: 270,
            cutout: '70%',
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    enabled: false
                }
            }
        },
        plugins: [{
            beforeDraw: function(chart) {
                const width = chart.width;
                const height = chart.height;
                const ctx = chart.ctx;
                
                ctx.restore();
                const fontSize = Math.min(width, height) / 8;
                ctx.font = fontSize + "px Arial";
                ctx.textBaseline = "middle";
                ctx.fillStyle = color;
                
                const text = Math.round(value) + unit;
                const textX = Math.round((width - ctx.measureText(text).width) / 2);
                const textY = height / 2;
                
                ctx.fillText(text, textX, textY);
                
                // Draw title
                ctx.font = (fontSize * 0.6) + "px Arial";
                ctx.fillStyle = "#666";
                const titleY = textY + fontSize * 0.8;
                const titleX = Math.round((width - ctx.measureText(title).width) / 2);
                ctx.fillText(title, titleX, titleY);
                
                ctx.save();
            }
        }]
    });
}

function refreshDashboard() {
    fetch('/monitoring/api/dashboard')
        .then(response => response.json())
        .then(data => {
            dashboardData = data;
            updateDashboard(data);
            showRefreshIndicator();
        })
        .catch(error => console.error('Error refreshing dashboard:', error));
}

function updateDashboard(data) {
    // Update overview metrics
    document.querySelector('.metric-card:nth-child(1) .metric-value').textContent = data.overview.requests_last_hour;
    document.querySelector('.metric-card:nth-child(2) .metric-value').textContent = data.overview.errors_last_hour;
    document.querySelector('.metric-card:nth-child(3) .metric-value').textContent = data.overview.error_rate_percent.toFixed(2) + '%';
    document.querySelector('.metric-card:nth-child(4) .metric-value').textContent = Math.round(data.overview.avg_response_time_ms) + 'ms';
    
    // Update timestamp
    document.getElementById('last-updated').textContent = new Date(data.timestamp).toLocaleString();
    
    // Reload system metrics
    loadSystemMetrics();
    
    // Update performance chart
    if (charts.performance) {
        const perfData = data.performance;
        charts.performance.data.datasets[0].data = [
            perfData.count || 0,
            perfData.min || 0,
            perfData.mean || 0,
            perfData.max || 0,
            perfData.p95 || 0,
            perfData.p99 || 0
        ];
        charts.performance.update();
    }
}

function showRefreshIndicator() {
    const indicator = document.getElementById('refresh-indicator');
    indicator.classList.add('show');
    setTimeout(() => {
        indicator.classList.remove('show');
    }, 2000);
}

// Manual alert check
function checkAlerts() {
    fetch('/monitoring/api/alerts/check', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            console.log('Alert check completed:', data);
            refreshDashboard();
        })
        .catch(error => console.error('Error checking alerts:', error));
}
</script>
{% endblock %}