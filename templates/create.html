{% extends "base.html" %}

{% block title %}Create Meal Plan - Cibozer{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="form-card">
                <h2 class="mb-4 text-center">
                    <i class="fas fa-magic me-2"></i>Create Your Meal Plan
                </h2>
                
                <form id="mealPlanForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <!-- Version: 2.1 - Removed action to prevent form submission issues -->
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="calories" class="form-label">
                                    Daily Calories
                                    <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" 
                                       title="Average adult needs 1800-2400 calories. Higher for active people, lower for weight loss."></i>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="calories" name="calories" 
                                           min="800" max="6000" value="2000" required>
                                    <button type="button" class="btn btn-outline-secondary" id="calcCalories">
                                        <i class="fas fa-calculator"></i> Calculate
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    <strong>Quick guide:</strong> Sedentary: 1600-1800 | Active: 2000-2200 | Very Active: 2400+
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="days" class="form-label">Number of Days</label>
                                <select class="form-select" id="days" name="days" required>
                                    <option value="1">1 Day</option>
                                    <option value="3">3 Days</option>
                                    <option value="7" selected>7 Days</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            Diet Type
                            <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" 
                               title="Choose the diet that best matches your eating preferences and health goals."></i>
                        </label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diet" id="standard" value="standard" checked>
                                    <label class="form-check-label" for="standard">
                                        Standard
                                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Balanced diet with all food groups. 45% carbs, 25% protein, 30% fat."></i>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diet" id="keto" value="keto">
                                    <label class="form-check-label" for="keto">
                                        Keto
                                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Very low carb, high fat diet. 5% carbs, 25% protein, 70% fat. May help with weight loss."></i>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diet" id="paleo" value="paleo">
                                    <label class="form-check-label" for="paleo">
                                        Paleo
                                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Whole foods only: meat, fish, eggs, vegetables, fruits, nuts. No grains or dairy."></i>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diet" id="vegan" value="vegan">
                                    <label class="form-check-label" for="vegan">
                                        Vegan
                                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="Plant-based only: no meat, dairy, eggs, or animal products. Rich in fiber and antioxidants."></i>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diet" id="vegetarian" value="vegetarian">
                                    <label class="form-check-label" for="vegetarian">
                                        Vegetarian
                                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="No meat or fish, but includes dairy and eggs. Good for heart health."></i>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diet" id="high_protein" value="high_protein">
                                    <label class="form-check-label" for="high_protein">
                                        High Protein
                                        <i class="fas fa-info-circle text-muted ms-1" data-bs-toggle="tooltip" 
                                           title="40% protein for muscle building and satiety. Ideal for athletes and fitness goals."></i>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="meal_structure" class="form-label">
                                    Meal Structure
                                    <i class="fas fa-info-circle text-muted" data-bs-toggle="tooltip" 
                                       title="Choose how you prefer to distribute your daily calories across meals."></i>
                                </label>
                                <select class="form-select" id="meal_structure" name="meal_structure" required>
                                    <option value="standard" selected data-bs-toggle="tooltip" title="Breakfast, lunch, dinner plus healthy snacks">Standard (3 meals + snacks)</option>
                                    <option value="3_plus_2" data-bs-toggle="tooltip" title="Three main meals with two planned snacks for steady energy">3 Meals + 2 Snacks</option>
                                    <option value="5_small" data-bs-toggle="tooltip" title="Five smaller meals throughout the day for stable blood sugar">5 Small Meals</option>
                                    <option value="16_8_if" data-bs-toggle="tooltip" title="Eat within 8 hours, fast for 16. Popular for weight management">Intermittent Fasting (16:8)</option>
                                    <option value="18_6_if" data-bs-toggle="tooltip" title="Eat within 6 hours, fast for 18. More advanced fasting">Intermittent Fasting (18:6)</option>
                                    <option value="omad" data-bs-toggle="tooltip" title="One large meal per day. Advanced fasting method">OMAD (One Meal a Day)</option>
                                    <option value="2_meals" data-bs-toggle="tooltip" title="Simple two-meal structure, often brunch and dinner">2 Meals</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="measurement_system" class="form-label">Measurements</label>
                                <select class="form-select" id="measurement_system" name="measurement_system" required>
                                    <option value="US" selected>Imperial (cups, tbsp, oz)</option>
                                    <option value="Metric">Metric (ml, g, kg)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="button" class="btn btn-outline-info me-3" onclick="startWizard()">
                            <i class="fas fa-question-circle me-2"></i>Need Help?
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-magic me-2"></i>Generate Meal Plan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-4">
                <h5 class="text-center mb-4">
                    <i class="fas fa-magic me-2 text-primary"></i>
                    Generating Your Meal Plan...
                </h5>
                
                <!-- Skeleton loader preview -->
                <div class="skeleton-preview">
                    <div class="skeleton skeleton-title mb-3"></div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="skeleton skeleton-card"></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="skeleton skeleton-card"></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="skeleton skeleton-card"></div>
                        </div>
                    </div>
                    <div class="skeleton skeleton-text"></div>
                    <div class="skeleton skeleton-text" style="width: 80%;"></div>
                    <div class="skeleton skeleton-text" style="width: 60%;"></div>
                </div>
                
                <p class="text-center text-muted mt-3 mb-0">
                    <small>Creating a personalized meal plan just for you...</small>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Setup Wizard Modal -->
<div class="modal fade" id="setupWizard" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-magic me-2"></i>Meal Planning Wizard
                    <small class="text-muted ms-2">Step <span id="wizardStep">1</span> of 4</small>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="wizardContent">
                <!-- Wizard steps will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Skip Wizard</button>
                <button type="button" class="btn btn-outline-primary" id="wizardPrev" onclick="previousWizardStep()" style="display: none;">Previous</button>
                <button type="button" class="btn btn-primary" id="wizardNext" onclick="nextWizardStep()">Next</button>
                <button type="button" class="btn btn-success" id="wizardComplete" onclick="completeWizard()" style="display: none;">Complete Setup</button>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Your Meal Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="mealPlanResults">
                <!-- Results will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">Print</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Debug Logger removed for production -->

<script>
// Simple form handler that works with clean JS
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mealPlanForm');
    if (!form) return;
    
    console.log('Meal plan form found');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('üéØ FORM SUBMITTED - Starting meal plan generation');
        
        // Show loading with clean JS
        console.log('üîÑ MODAL FLOW: About to show loading modal...');
        console.log('üîÑ CibozerClean available:', !!window.CibozerClean);
        
        if (window.CibozerClean) {
            console.log('üîÑ MODAL FLOW: Calling CibozerClean.showLoading...');
            window.CibozerClean.showLoading('Generating your meal plan...');
            console.log('üîÑ MODAL FLOW: showLoading called');
        } else {
            console.error('‚ùå CibozerClean not available!');
            // Fallback loading display
            console.log('üîÑ MODAL FLOW: Using fallback loading...');
        }
        
        try {
            // Collect form data
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Remove CSRF token from data (it's sent in header)
            delete data.csrf_token;
            
            console.log('üìã FORM DATA COLLECTED:', data);
            console.log('üîç Data keys:', Object.keys(data));
            console.log('üîç Data values:', Object.values(data));
            console.log('üåê Making API request to /api/generate...');
            console.log('üì§ Request payload:', JSON.stringify(data, null, 2));
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name="csrf_token"]').value;
            console.log('üîë CSRF Token:', csrfToken);
            
            // Make request (cache-busted version)
            const response = await fetch('/api/generate?v=' + Date.now(), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(data)
            });
            
            console.log('üì° API RESPONSE received:', response.status, response.statusText);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('üìõ API ERROR RESPONSE:', errorText);
                throw new Error(errorText || `HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log('üìä API RESULT:', result);
            console.log('üìä API RESULT KEYS:', Object.keys(result));
            console.log('üìä API RESULT SUCCESS:', result.success);
            console.log('üìä API RESULT MEAL_PLAN EXISTS:', 'meal_plan' in result);
            if ('meal_plan' in result) {
                console.log('üìä MEAL_PLAN KEYS:', Object.keys(result.meal_plan || {}));
                console.log('üìä MEAL_PLAN VALUE:', result.meal_plan);
            } else {
                console.log('üìä NO MEAL_PLAN KEY FOUND');
            }
            
            // Log validation details if present
            if (result.details) {
                console.log('‚ùå VALIDATION DETAILS:', result.details);
            }
            
            // Hide loading
            console.log('üîÑ MODAL FLOW: About to hide loading modal...');
            if (window.CibozerClean) {
                console.log('üîÑ MODAL FLOW: Calling CibozerClean.hideLoading...');
                window.CibozerClean.hideLoading();
                console.log('üîÑ MODAL FLOW: hideLoading called');
            } else {
                console.log('üîÑ MODAL FLOW: CibozerClean not available for hiding');
            }
            
            if (result.success) {
                console.log('‚úÖ SUCCESS - Meal plan generated successfully');
                
                // Create proper meal plan display
                let mealPlanHTML = `
                    <div class="alert alert-success">
                        <h4><i class="fas fa-check-circle me-2"></i>Success!</h4>
                        <p>Your meal plan has been generated successfully.</p>
                    </div>
                `;
                
                if (result.meal_plan && result.meal_plan.days) {
                    console.log('üìä MEAL PLAN STRUCTURE:', result.meal_plan);
                    console.log('üìä FIRST DAY:', result.meal_plan.days[0]);
                    if (result.meal_plan.days[0] && result.meal_plan.days[0].meals[0]) {
                        console.log('üìä FIRST MEAL:', result.meal_plan.days[0].meals[0]);
                    }
                    
                    // Display meal plan by days
                    for (const dayData of result.meal_plan.days) {
                        mealPlanHTML += `
                            <div class="mb-4">
                                <h5 class="text-primary">Day ${dayData.day}</h5>
                                <div class="row">
                        `;
                        
                        // Display each meal for this day
                        for (const mealData of dayData.meals) {
                        mealPlanHTML += `
                            <div class="col-md-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-utensils me-2"></i>${mealData.meal_type ? mealData.meal_type.charAt(0).toUpperCase() + mealData.meal_type.slice(1) : 'Meal'}</h5>
                                    </div>
                                    <div class="card-body">
                                        <h6 class="card-title">${mealData.name}</h6>
                                        <div class="row text-center mb-3">
                                            <div class="col-3">
                                                <small class="text-muted">Calories</small>
                                                <div class="fw-bold">${mealData.calories}</div>
                                            </div>
                                            <div class="col-3">
                                                <small class="text-muted">Protein</small>
                                                <div class="fw-bold">${mealData.macros?.protein || 0}g</div>
                                            </div>
                                            <div class="col-3">
                                                <small class="text-muted">Carbs</small>
                                                <div class="fw-bold">${mealData.macros?.carbs || 0}g</div>
                                            </div>
                                            <div class="col-3">
                                                <small class="text-muted">Fat</small>
                                                <div class="fw-bold">${mealData.macros?.fat || 0}g</div>
                                            </div>
                                        </div>
                                        <h6>Ingredients:</h6>
                                        <ul class="list-unstyled">
                                            ${mealData.ingredients ? mealData.ingredients.map(ing => `<li><i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i>${ing}</li>`).join('') : ''}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                        }
                        
                        mealPlanHTML += '</div></div>';  // Close row and day div
                    }
                    
                    // Add summary if available
                    if (result.meal_plan.summary) {
                        const summary = result.meal_plan.summary;
                        mealPlanHTML += `
                            <div class="card mt-4">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Meal Plan Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <h3 class="text-primary">${summary.total_days}</h3>
                                            <small class="text-muted">Total Days</small>
                                        </div>
                                        <div class="col-4">
                                            <h3 class="text-success">${summary.total_meals}</h3>
                                            <small class="text-muted">Total Meals</small>
                                        </div>
                                        <div class="col-4">
                                            <h3 class="text-warning">${Math.round(summary.average_daily_calories)}</h3>
                                            <small class="text-muted">Avg Daily Calories</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Add action buttons
                    mealPlanHTML += `
                        <div class="text-center mt-4">
                            <button class="btn btn-primary me-2" onclick="downloadPDF()">
                                <i class="fas fa-download me-2"></i>Download PDF
                            </button>
                            <button class="btn btn-outline-secondary me-2" onclick="viewShoppingList()">
                                <i class="fas fa-shopping-cart me-2"></i>Shopping List
                            </button>
                            <button class="btn btn-outline-primary" onclick="generateAnother()">
                                <i class="fas fa-refresh me-2"></i>Generate Another
                            </button>
                        </div>
                    `;
                } else {
                    mealPlanHTML += '<div class="alert alert-warning">No meal plan data received.</div>';
                }
                
                document.getElementById('mealPlanResults').innerHTML = mealPlanHTML;
                
                // Show results modal
                console.log('üìã MODAL FLOW: About to show results modal...');
                console.log('üìã MODAL FLOW: Looking for resultsModal element...');
                const resultsModalElement = document.getElementById('resultsModal');
                console.log('üìã MODAL FLOW: resultsModal element found:', !!resultsModalElement);
                
                if (resultsModalElement) {
                    console.log('üìã MODAL FLOW: Creating Bootstrap modal instance...');
                    // Mark modal as intentionally visible to prevent cleanup
                    resultsModalElement.dataset.shouldBeVisible = 'true';
                    const resultsModal = new bootstrap.Modal(resultsModalElement);
                    console.log('üìã MODAL FLOW: Calling modal.show()...');
                    resultsModal.show();
                    console.log('üìã MODAL FLOW: modal.show() called');
                } else {
                    console.error('üìã MODAL FLOW: resultsModal element not found!');
                }
            } else {
                console.error('‚ùå API ERROR:', result.error);
                throw new Error(result.error || 'Failed to generate meal plan');
            }
            
        } catch (error) {
            console.error('üö® CATCH ERROR:', error);
            console.error('üö® ERROR MESSAGE:', error.message);
            console.error('üö® ERROR STACK:', error.stack);
            
            // Hide loading on error
            console.log('üîÑ MODAL FLOW: Error occurred, hiding loading modal...');
            if (window.CibozerClean) {
                console.log('üîÑ MODAL FLOW: Calling hideLoading on error...');
                window.CibozerClean.hideLoading();
                console.log('üîÑ MODAL FLOW: Showing error notification...');
                window.CibozerClean.showNotification('Error: ' + error.message, 'danger');
                console.log('üîÑ MODAL FLOW: Error handling complete');
            } else {
                console.log('üîÑ MODAL FLOW: CibozerClean not available for error handling');
            }
        }
    });
});

// Helper functions for meal plan actions
function downloadPDF() {
    console.log('Download PDF clicked');
    alert('PDF download feature coming soon!');
}

function viewShoppingList() {
    console.log('View shopping list clicked');
    alert('Shopping list feature coming soon!');
}

function generateAnother() {
    console.log('Generate another clicked');
    location.reload();
}

// Calorie calculator function
function calculateCalories() {
    // Simple calorie calculator modal
    const calculatorHTML = `
        <div class="modal fade" id="calorieCalculator" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-calculator me-2"></i>Calorie Calculator</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label">Age</label>
                                    <input type="number" class="form-control" id="calcAge" min="10" max="100" value="30">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label">Measurement System</label>
                                    <select class="form-select" id="calcUnits" onchange="toggleUnits()">
                                        <option value="imperial">Imperial (lbs, inches)</option>
                                        <option value="metric">Metric (kg, cm)</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label" id="weightLabel">Weight (lbs)</label>
                                    <input type="number" class="form-control" id="calcWeight" min="50" max="500" value="150">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label class="form-label" id="heightLabel">Height (inches)</label>
                                    <input type="number" class="form-control" id="calcHeight" min="36" max="96" value="66">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label">Gender</label>
                                    <select class="form-select" id="calcGender">
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">Activity Level</label>
                            <select class="form-select" id="calcActivity">
                                <option value="1.2">Sedentary (little/no exercise)</option>
                                <option value="1.375" selected>Lightly active (light exercise 1-3 days/week)</option>
                                <option value="1.55">Moderately active (moderate exercise 3-5 days/week)</option>
                                <option value="1.725">Very active (hard exercise 6-7 days/week)</option>
                                <option value="1.9">Extra active (very hard exercise, physical job)</option>
                            </select>
                        </div>
                        <div class="form-group mb-3">
                            <label class="form-label">Goal</label>
                            <select class="form-select" id="calcGoal">
                                <option value="-500" data-imperial="Lose weight (1 lb/week)" data-metric="Lose weight (0.5 kg/week)">Lose weight (1 lb/week)</option>
                                <option value="-250" data-imperial="Lose weight slowly (0.5 lb/week)" data-metric="Lose weight slowly (0.25 kg/week)">Lose weight slowly (0.5 lb/week)</option>
                                <option value="0" data-imperial="Maintain weight" data-metric="Maintain weight" selected>Maintain weight</option>
                                <option value="250" data-imperial="Gain weight slowly (0.5 lb/week)" data-metric="Gain weight slowly (0.25 kg/week)">Gain weight slowly (0.5 lb/week)</option>
                                <option value="500" data-imperial="Gain weight (1 lb/week)" data-metric="Gain weight (0.5 kg/week)">Gain weight (1 lb/week)</option>
                            </select>
                        </div>
                        <div class="alert alert-info" id="calcResult" style="display: none;">
                            <h6>Recommended Daily Calories:</h6>
                            <div class="h4 text-primary" id="calcCalories">0</div>
                            <small class="text-muted">Based on Mifflin-St Jeor equation</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="performCalcuation()">Calculate</button>
                        <button type="button" class="btn btn-success" onclick="useCalculatedCalories()" id="useCalcBtn" style="display: none;">Use This Amount</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing calculator if present
    const existing = document.getElementById('calorieCalculator');
    if (existing) existing.remove();
    
    // Add calculator to page
    document.body.insertAdjacentHTML('beforeend', calculatorHTML);
    
    // Show calculator
    const calculator = new bootstrap.Modal(document.getElementById('calorieCalculator'));
    calculator.show();
}

// Toggle between metric and imperial units
function toggleUnits() {
    const units = document.getElementById('calcUnits').value;
    const weightInput = document.getElementById('calcWeight');
    const heightInput = document.getElementById('calcHeight');
    const weightLabel = document.getElementById('weightLabel');
    const heightLabel = document.getElementById('heightLabel');
    
    if (units === 'metric') {
        // Convert current values to metric
        const currentWeight = parseFloat(weightInput.value) || 150;
        const currentHeight = parseFloat(heightInput.value) || 66;
        
        // Convert lbs to kg and inches to cm
        const weightKg = Math.round(currentWeight * 0.453592);
        const heightCm = Math.round(currentHeight * 2.54);
        
        weightInput.value = weightKg;
        heightInput.value = heightCm;
        weightInput.min = 30; // 30 kg minimum
        weightInput.max = 300; // 300 kg maximum
        heightInput.min = 100; // 100 cm minimum (3'3")
        heightInput.max = 250; // 250 cm maximum (8'2")
        
        weightLabel.textContent = 'Weight (kg)';
        heightLabel.textContent = 'Height (cm)';
    } else {
        // Convert current values to imperial
        const currentWeight = parseFloat(weightInput.value) || 68;
        const currentHeight = parseFloat(heightInput.value) || 168;
        
        // Convert kg to lbs and cm to inches
        const weightLbs = Math.round(currentWeight / 0.453592);
        const heightInches = Math.round(currentHeight / 2.54);
        
        weightInput.value = weightLbs;
        heightInput.value = heightInches;
        weightInput.min = 50; // 50 lbs minimum
        weightInput.max = 500; // 500 lbs maximum
        heightInput.min = 36; // 36 inches minimum (3 feet)
        heightInput.max = 96; // 96 inches maximum (8 feet)
        
        weightLabel.textContent = 'Weight (lbs)';
        heightLabel.textContent = 'Height (inches)';
    }
    
    // Update goal labels based on unit system
    const goalSelect = document.getElementById('calcGoal');
    const options = goalSelect.querySelectorAll('option');
    
    options.forEach(option => {
        const imperialText = option.getAttribute('data-imperial');
        const metricText = option.getAttribute('data-metric');
        
        if (units === 'metric' && metricText) {
            option.textContent = metricText;
        } else if (imperialText) {
            option.textContent = imperialText;
        }
    });
}

// Perform calorie calculation with unit conversion
function performCalcuation() {
    const age = parseInt(document.getElementById('calcAge').value);
    const weight = parseFloat(document.getElementById('calcWeight').value);
    const height = parseFloat(document.getElementById('calcHeight').value);
    const gender = document.getElementById('calcGender').value;
    const activity = parseFloat(document.getElementById('calcActivity').value);
    const goal = parseInt(document.getElementById('calcGoal').value);
    const units = document.getElementById('calcUnits').value;
    
    // Convert to metric for calculation (Mifflin-St Jeor uses kg and cm)
    let weightKg, heightCm;
    
    if (units === 'imperial') {
        weightKg = weight * 0.453592; // lbs to kg
        heightCm = height * 2.54;     // inches to cm
    } else {
        weightKg = weight;            // already kg
        heightCm = height;            // already cm
    }
    
    // Mifflin-St Jeor equation (metric)
    let bmr;
    if (gender === 'male') {
        bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) + 5;
    } else {
        bmr = (10 * weightKg) + (6.25 * heightCm) - (5 * age) - 161;
    }
    
    const tdee = bmr * activity;
    const targetCalories = Math.round(tdee + goal);
    
    document.getElementById('calcCalories').textContent = targetCalories;
    document.getElementById('calcResult').style.display = 'block';
    document.getElementById('useCalcBtn').style.display = 'inline-block';
    
    // Store calculated value
    window.calculatedCalories = targetCalories;
}

// Use calculated calories in main form
function useCalculatedCalories() {
    if (window.calculatedCalories) {
        document.getElementById('calories').value = window.calculatedCalories;
        bootstrap.Modal.getInstance(document.getElementById('calorieCalculator')).hide();
    }
}

// Wizard functionality
let currentWizardStep = 1;
const wizardData = {};

const wizardSteps = {
    1: {
        title: "Tell us about your goals",
        content: `
            <div class="text-center mb-4">
                <i class="fas fa-bullseye fa-3x text-primary mb-3"></i>
                <h4>What's your main goal?</h4>
                <p class="text-muted">This helps us recommend the right approach for you.</p>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card goal-card" data-goal="weight_loss">
                        <div class="card-body text-center">
                            <i class="fas fa-weight fa-2x text-success mb-2"></i>
                            <h5>Lose Weight</h5>
                            <p class="small text-muted">Reduce calories, focus on nutrition</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card goal-card" data-goal="muscle_gain">
                        <div class="card-body text-center">
                            <i class="fas fa-dumbbell fa-2x text-primary mb-2"></i>
                            <h5>Build Muscle</h5>
                            <p class="small text-muted">High protein, adequate calories</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card goal-card" data-goal="maintain">
                        <div class="card-body text-center">
                            <i class="fas fa-balance-scale fa-2x text-info mb-2"></i>
                            <h5>Maintain Weight</h5>
                            <p class="small text-muted">Balanced nutrition, stable calories</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card goal-card" data-goal="health">
                        <div class="card-body text-center">
                            <i class="fas fa-heart fa-2x text-danger mb-2"></i>
                            <h5>Improve Health</h5>
                            <p class="small text-muted">Focus on whole foods, nutrients</p>
                        </div>
                    </div>
                </div>
            </div>
        `
    },
    2: {
        title: "Your eating preferences",
        content: `
            <div class="text-center mb-4">
                <i class="fas fa-utensils fa-3x text-primary mb-3"></i>
                <h4>Any dietary preferences or restrictions?</h4>
                <p class="text-muted">We'll make sure your meal plan fits your lifestyle.</p>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <h6>Dietary Preferences:</h6>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="wiz_vegetarian" value="vegetarian">
                        <label class="form-check-label" for="wiz_vegetarian">Vegetarian</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="wiz_vegan" value="vegan">
                        <label class="form-check-label" for="wiz_vegan">Vegan</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="wiz_keto" value="keto">
                        <label class="form-check-label" for="wiz_keto">Keto/Low Carb</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="wiz_paleo" value="paleo">
                        <label class="form-check-label" for="wiz_paleo">Paleo</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>Food Allergies/Restrictions:</h6>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="wiz_gluten" value="gluten">
                        <label class="form-check-label" for="wiz_gluten">Gluten-free</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="wiz_dairy" value="dairy">
                        <label class="form-check-label" for="wiz_dairy">Dairy-free</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="wiz_nuts" value="nuts">
                        <label class="form-check-label" for="wiz_nuts">Nut-free</label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="wiz_eggs" value="eggs">
                        <label class="form-check-label" for="wiz_eggs">Egg-free</label>
                    </div>
                </div>
            </div>
        `
    },
    3: {
        title: "Your lifestyle",
        content: `
            <div class="text-center mb-4">
                <i class="fas fa-running fa-3x text-primary mb-3"></i>
                <h4>How active are you?</h4>
                <p class="text-muted">This helps us estimate your calorie needs.</p>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card activity-card" data-activity="sedentary" data-multiplier="1.2" data-calories="1600-1800">
                        <div class="card-body text-center">
                            <i class="fas fa-chair fa-2x text-secondary mb-2"></i>
                            <h5>Sedentary</h5>
                            <p class="small text-muted">Desk job, little exercise<br><strong>~1600-1800 calories</strong></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card activity-card" data-activity="light" data-multiplier="1.375" data-calories="1800-2000">
                        <div class="card-body text-center">
                            <i class="fas fa-walking fa-2x text-info mb-2"></i>
                            <h5>Lightly Active</h5>
                            <p class="small text-muted">Light exercise 1-3 days/week<br><strong>~1800-2000 calories</strong></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card activity-card" data-activity="moderate" data-multiplier="1.55" data-calories="2000-2200">
                        <div class="card-body text-center">
                            <i class="fas fa-bicycle fa-2x text-warning mb-2"></i>
                            <h5>Moderately Active</h5>
                            <p class="small text-muted">Exercise 3-5 days/week<br><strong>~2000-2200 calories</strong></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card activity-card" data-activity="very_active" data-multiplier="1.725" data-calories="2200-2600">
                        <div class="card-body text-center">
                            <i class="fas fa-running fa-2x text-success mb-2"></i>
                            <h5>Very Active</h5>
                            <p class="small text-muted">Intense exercise 6-7 days/week<br><strong>~2200-2600 calories</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        `
    },
    4: {
        title: "Perfect! Let's set up your plan",
        content: `
            <div class="text-center mb-4">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h4>Your Personalized Recommendations</h4>
                <p class="text-muted">Based on your responses, here's what we recommend:</p>
            </div>
            <div id="wizard-recommendations">
                <!-- Recommendations will be populated here -->
            </div>
            <div class="alert alert-info mt-4">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Don't worry!</strong> You can always adjust these settings on the main form before generating your meal plan.
            </div>
        `
    }
};

function startWizard() {
    currentWizardStep = 1;
    showWizardStep(1);
    const wizard = new bootstrap.Modal(document.getElementById('setupWizard'));
    wizard.show();
}

function showWizardStep(step) {
    const stepData = wizardSteps[step];
    document.getElementById('wizardStep').textContent = step;
    document.getElementById('wizardContent').innerHTML = stepData.content;
    
    // Update button visibility
    document.getElementById('wizardPrev').style.display = step > 1 ? 'inline-block' : 'none';
    document.getElementById('wizardNext').style.display = step < 4 ? 'inline-block' : 'none';
    document.getElementById('wizardComplete').style.display = step === 4 ? 'inline-block' : 'none';
    
    // Add event listeners for step-specific elements
    if (step === 1) {
        document.querySelectorAll('.goal-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.goal-card').forEach(c => c.classList.remove('border-primary', 'bg-light'));
                this.classList.add('border-primary', 'bg-light');
                wizardData.goal = this.dataset.goal;
            });
        });
    } else if (step === 3) {
        document.querySelectorAll('.activity-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.activity-card').forEach(c => c.classList.remove('border-primary', 'bg-light'));
                this.classList.add('border-primary', 'bg-light');
                wizardData.activity = this.dataset.activity;
                wizardData.activityMultiplier = this.dataset.multiplier;
                wizardData.suggestedCalories = this.dataset.calories;
            });
        });
    } else if (step === 4) {
        generateRecommendations();
    }
}

function nextWizardStep() {
    // Collect data from current step
    if (currentWizardStep === 2) {
        const preferences = [];
        const restrictions = [];
        document.querySelectorAll('#wizardContent input[type="checkbox"]:checked').forEach(checkbox => {
            if (['vegetarian', 'vegan', 'keto', 'paleo'].includes(checkbox.value)) {
                preferences.push(checkbox.value);
            } else {
                restrictions.push(checkbox.value);
            }
        });
        wizardData.preferences = preferences;
        wizardData.restrictions = restrictions;
    }
    
    if (currentWizardStep < 4) {
        currentWizardStep++;
        showWizardStep(currentWizardStep);
    }
}

function previousWizardStep() {
    if (currentWizardStep > 1) {
        currentWizardStep--;
        showWizardStep(currentWizardStep);
    }
}

function generateRecommendations() {
    let diet = 'standard';
    let calories = 2000;
    let mealStructure = 'standard';
    
    // Determine diet based on preferences
    if (wizardData.preferences?.includes('vegan')) diet = 'vegan';
    else if (wizardData.preferences?.includes('vegetarian')) diet = 'vegetarian';
    else if (wizardData.preferences?.includes('keto')) diet = 'keto';
    else if (wizardData.preferences?.includes('paleo')) diet = 'paleo';
    else if (wizardData.goal === 'muscle_gain') diet = 'high_protein';
    
    // Determine calories based on goal and activity
    const baseCalories = {
        'sedentary': 1700,
        'light': 1900,
        'moderate': 2100,
        'very_active': 2400
    };
    
    let baseCal = baseCalories[wizardData.activity] || 2000;
    
    if (wizardData.goal === 'weight_loss') calories = baseCal - 300;
    else if (wizardData.goal === 'muscle_gain') calories = baseCal + 300;
    else calories = baseCal;
    
    // Generate recommendations HTML
    const recommendationsHTML = `
        <div class="row">
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-utensils fa-2x text-primary mb-2"></i>
                        <h5>Diet Type</h5>
                        <p class="h6 text-primary">${diet.charAt(0).toUpperCase() + diet.slice(1).replace('_', ' ')}</p>
                        <small class="text-muted">Based on your preferences</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-fire fa-2x text-danger mb-2"></i>
                        <h5>Daily Calories</h5>
                        <p class="h6 text-danger">${calories}</p>
                        <small class="text-muted">Based on your activity & goal</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-success mb-2"></i>
                        <h5>Meal Structure</h5>
                        <p class="h6 text-success">Standard</p>
                        <small class="text-muted">3 meals + healthy snacks</small>
                    </div>
                </div>
            </div>
        </div>
        ${wizardData.restrictions?.length ? `
        <div class="alert alert-warning">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Dietary Restrictions Noted:</h6>
            <p class="mb-0">We'll avoid: ${wizardData.restrictions.join(', ')}</p>
        </div>
        ` : ''}
    `;
    
    document.getElementById('wizard-recommendations').innerHTML = recommendationsHTML;
    
    // Store recommendations for form population
    wizardData.recommendedDiet = diet;
    wizardData.recommendedCalories = calories;
    wizardData.recommendedMealStructure = mealStructure;
}

function completeWizard() {
    // Populate main form with recommendations
    if (wizardData.recommendedDiet) {
        document.getElementById(wizardData.recommendedDiet).checked = true;
    }
    if (wizardData.recommendedCalories) {
        document.getElementById('calories').value = wizardData.recommendedCalories;
    }
    if (wizardData.recommendedMealStructure) {
        document.getElementById('meal_structure').value = wizardData.recommendedMealStructure;
    }
    
    // Close wizard
    bootstrap.Modal.getInstance(document.getElementById('setupWizard')).hide();
    
    // Show success notification
    if (window.CibozerClean) {
        window.CibozerClean.showNotification('Great! Your form has been pre-filled with personalized recommendations.', 'success');
    }
}

// Initialize tooltips and calculator button
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => {
        new bootstrap.Tooltip(tooltip);
    });
    
    // Add calculator button event
    const calcButton = document.getElementById('calcCalories');
    if (calcButton) {
        calcButton.addEventListener('click', calculateCalories);
    }
});
</script>
{% endblock %}