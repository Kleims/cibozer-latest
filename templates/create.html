{% extends "base.html" %}

{% block title %}Create Meal Plan - Cibozer{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="form-card">
                <h2 class="mb-4 text-center">
                    <i class="fas fa-magic me-2"></i>Create Your Meal Plan
                </h2>
                
                <form id="mealPlanForm" method="POST" action="/api/generate?v={{ range(100000, 999999) | random }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <!-- Version: 2.0 - Fixed field names -->
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="calories" class="form-label">Daily Calories</label>
                                <input type="number" class="form-control" id="calories" name="calories" 
                                       min="800" max="6000" value="2000" required>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="days" class="form-label">Number of Days</label>
                                <select class="form-select" id="days" name="days" required>
                                    <option value="1">1 Day</option>
                                    <option value="3">3 Days</option>
                                    <option value="7" selected>7 Days</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Diet Type</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diet" id="standard" value="standard" checked>
                                    <label class="form-check-label" for="standard">Standard</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diet" id="keto" value="keto">
                                    <label class="form-check-label" for="keto">Keto</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diet" id="paleo" value="paleo">
                                    <label class="form-check-label" for="paleo">Paleo</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diet" id="vegan" value="vegan">
                                    <label class="form-check-label" for="vegan">Vegan</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diet" id="vegetarian" value="vegetarian">
                                    <label class="form-check-label" for="vegetarian">Vegetarian</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="diet" id="high_protein" value="high_protein">
                                    <label class="form-check-label" for="high_protein">High Protein</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="meal_structure" class="form-label">Meal Structure</label>
                        <select class="form-select" id="meal_structure" name="meal_structure" required>
                            <option value="standard" selected>Standard (3 meals + snacks)</option>
                            <option value="3_plus_2">3 Meals + 2 Snacks</option>
                            <option value="5_small">5 Small Meals</option>
                            <option value="16_8_if">Intermittent Fasting (16:8)</option>
                            <option value="18_6_if">Intermittent Fasting (18:6)</option>
                            <option value="omad">OMAD (One Meal a Day)</option>
                            <option value="2_meals">2 Meals</option>
                        </select>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-magic me-2"></i>Generate Meal Plan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Generating Your Meal Plan...</h5>
                <p class="text-muted">This may take a few moments</p>
            </div>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Your Meal Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="mealPlanResults">
                <!-- Results will be populated here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="window.print()">Print</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Debug Logger -->
<script src="{{ url_for('static', filename='js/debug-logger.js') }}"></script>

<script>
// Simple form handler that works with clean JS
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('mealPlanForm');
    if (!form) return;
    
    console.log('Meal plan form found');
    
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('üéØ FORM SUBMITTED - Starting meal plan generation');
        
        // Show loading with clean JS
        console.log('üîÑ MODAL FLOW: About to show loading modal...');
        console.log('üîÑ CibozerClean available:', !!window.CibozerClean);
        
        if (window.CibozerClean) {
            console.log('üîÑ MODAL FLOW: Calling CibozerClean.showLoading...');
            window.CibozerClean.showLoading('Generating your meal plan...');
            console.log('üîÑ MODAL FLOW: showLoading called');
        } else {
            console.error('‚ùå CibozerClean not available!');
            // Fallback loading display
            console.log('üîÑ MODAL FLOW: Using fallback loading...');
        }
        
        try {
            // Collect form data
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // Remove CSRF token from data (it's sent in header)
            delete data.csrf_token;
            
            console.log('üìã FORM DATA COLLECTED:', data);
            console.log('üîç Data keys:', Object.keys(data));
            console.log('üîç Data values:', Object.values(data));
            console.log('üåê Making API request to /api/generate...');
            console.log('üì§ Request payload:', JSON.stringify(data, null, 2));
            
            // Make request (cache-busted version)
            const response = await fetch('/api/generate?v=' + Date.now(), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('[name="csrf_token"]').value
                },
                body: JSON.stringify(data)
            });
            
            console.log('üì° API RESPONSE received:', response.status, response.statusText);
            
            const result = await response.json();
            console.log('üìä API RESULT:', result);
            console.log('üìä API RESULT KEYS:', Object.keys(result));
            console.log('üìä API RESULT SUCCESS:', result.success);
            console.log('üìä API RESULT MEAL_PLAN EXISTS:', 'meal_plan' in result);
            if ('meal_plan' in result) {
                console.log('üìä MEAL_PLAN KEYS:', Object.keys(result.meal_plan || {}));
                console.log('üìä MEAL_PLAN VALUE:', result.meal_plan);
            } else {
                console.log('üìä NO MEAL_PLAN KEY FOUND');
            }
            
            // Log validation details if present
            if (result.details) {
                console.log('‚ùå VALIDATION DETAILS:', result.details);
            }
            
            // Hide loading
            console.log('üîÑ MODAL FLOW: About to hide loading modal...');
            if (window.CibozerClean) {
                console.log('üîÑ MODAL FLOW: Calling CibozerClean.hideLoading...');
                window.CibozerClean.hideLoading();
                console.log('üîÑ MODAL FLOW: hideLoading called');
            } else {
                console.log('üîÑ MODAL FLOW: CibozerClean not available for hiding');
            }
            
            if (result.success) {
                console.log('‚úÖ SUCCESS - Meal plan generated successfully');
                
                // Create proper meal plan display
                let mealPlanHTML = `
                    <div class="alert alert-success">
                        <h4><i class="fas fa-check-circle me-2"></i>Success!</h4>
                        <p>Your meal plan has been generated successfully.</p>
                    </div>
                `;
                
                if (result.meal_plan && result.meal_plan.meals) {
                    mealPlanHTML += '<div class="row">';
                    
                    // Display each meal
                    for (const [mealType, mealData] of Object.entries(result.meal_plan.meals)) {
                        mealPlanHTML += `
                            <div class="col-md-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-utensils me-2"></i>${mealType.charAt(0).toUpperCase() + mealType.slice(1)}</h5>
                                    </div>
                                    <div class="card-body">
                                        <h6 class="card-title">${mealData.name}</h6>
                                        <div class="row text-center mb-3">
                                            <div class="col-3">
                                                <small class="text-muted">Calories</small>
                                                <div class="fw-bold">${mealData.calories}</div>
                                            </div>
                                            <div class="col-3">
                                                <small class="text-muted">Protein</small>
                                                <div class="fw-bold">${mealData.protein}g</div>
                                            </div>
                                            <div class="col-3">
                                                <small class="text-muted">Carbs</small>
                                                <div class="fw-bold">${mealData.carbs}g</div>
                                            </div>
                                            <div class="col-3">
                                                <small class="text-muted">Fat</small>
                                                <div class="fw-bold">${mealData.fat}g</div>
                                            </div>
                                        </div>
                                        <h6>Ingredients:</h6>
                                        <ul class="list-unstyled">
                                            ${mealData.ingredients.map(ing => `<li><i class="fas fa-circle me-2" style="font-size: 0.5rem;"></i>${ing}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    mealPlanHTML += '</div>';
                    
                    // Add totals if available
                    if (result.meal_plan.totals) {
                        const totals = result.meal_plan.totals;
                        mealPlanHTML += `
                            <div class="card mt-4">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Daily Totals</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-3">
                                            <h3 class="text-primary">${totals.calories}</h3>
                                            <small class="text-muted">Total Calories</small>
                                        </div>
                                        <div class="col-3">
                                            <h3 class="text-success">${totals.protein}g</h3>
                                            <small class="text-muted">Protein</small>
                                        </div>
                                        <div class="col-3">
                                            <h3 class="text-warning">${totals.carbs}g</h3>
                                            <small class="text-muted">Carbohydrates</small>
                                        </div>
                                        <div class="col-3">
                                            <h3 class="text-info">${totals.fat}g</h3>
                                            <small class="text-muted">Fat</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Add action buttons
                    mealPlanHTML += `
                        <div class="text-center mt-4">
                            <button class="btn btn-primary me-2" onclick="downloadPDF()">
                                <i class="fas fa-download me-2"></i>Download PDF
                            </button>
                            <button class="btn btn-outline-secondary me-2" onclick="viewShoppingList()">
                                <i class="fas fa-shopping-cart me-2"></i>Shopping List
                            </button>
                            <button class="btn btn-outline-primary" onclick="generateAnother()">
                                <i class="fas fa-refresh me-2"></i>Generate Another
                            </button>
                        </div>
                    `;
                } else {
                    mealPlanHTML += '<div class="alert alert-warning">No meal plan data received.</div>';
                }
                
                document.getElementById('mealPlanResults').innerHTML = mealPlanHTML;
                
                // Show results modal
                console.log('üìã MODAL FLOW: About to show results modal...');
                console.log('üìã MODAL FLOW: Looking for resultsModal element...');
                const resultsModalElement = document.getElementById('resultsModal');
                console.log('üìã MODAL FLOW: resultsModal element found:', !!resultsModalElement);
                
                if (resultsModalElement) {
                    console.log('üìã MODAL FLOW: Creating Bootstrap modal instance...');
                    const resultsModal = new bootstrap.Modal(resultsModalElement);
                    console.log('üìã MODAL FLOW: Calling modal.show()...');
                    resultsModal.show();
                    console.log('üìã MODAL FLOW: modal.show() called');
                } else {
                    console.error('üìã MODAL FLOW: resultsModal element not found!');
                }
            } else {
                console.error('‚ùå API ERROR:', result.error);
                throw new Error(result.error || 'Failed to generate meal plan');
            }
            
        } catch (error) {
            console.error('üö® CATCH ERROR:', error);
            console.error('üö® ERROR MESSAGE:', error.message);
            console.error('üö® ERROR STACK:', error.stack);
            
            // Hide loading on error
            console.log('üîÑ MODAL FLOW: Error occurred, hiding loading modal...');
            if (window.CibozerClean) {
                console.log('üîÑ MODAL FLOW: Calling hideLoading on error...');
                window.CibozerClean.hideLoading();
                console.log('üîÑ MODAL FLOW: Showing error notification...');
                window.CibozerClean.showNotification('Error: ' + error.message, 'danger');
                console.log('üîÑ MODAL FLOW: Error handling complete');
            } else {
                console.log('üîÑ MODAL FLOW: CibozerClean not available for error handling');
            }
        }
    });
});
</script>
{% endblock %}