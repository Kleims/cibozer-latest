{% extends "base.html" %}

{% block title %}My Account - Cibozer{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-3">
            <!-- Account Navigation -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Account Menu</h5>
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action active">
                            <i class="fas fa-user me-2"></i>Dashboard
                        </a>
                        <a href="{{ url_for('create_meal_plan') }}" class="list-group-item list-group-item-action">
                            <i class="fas fa-plus me-2"></i>Create Plan
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" id="viewSavedPlans">
                            <i class="fas fa-save me-2"></i>Saved Plans
                        </a>
                        <a href="{{ url_for('auth.upgrade') }}" class="list-group-item list-group-item-action">
                            <i class="fas fa-crown me-2"></i>Upgrade
                        </a>
                        <a href="{{ url_for('auth.logout') }}" class="list-group-item list-group-item-action text-danger">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-9">
            <!-- Account Overview -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Account Overview</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Email:</strong> {{ current_user.email }}</p>
                            <p><strong>Name:</strong> {{ current_user.full_name or 'Not set' }}</p>
                            <p><strong>Member Since:</strong> {{ current_user.created_at.strftime('%B %Y') }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Subscription:</strong> 
                                <span class="badge bg-{{ 'success' if current_user.is_premium() else 'secondary' }}">
                                    {{ current_user.subscription_tier.title() }}
                                </span>
                            </p>
                            <p><strong>Credits:</strong> 
                                {% if current_user.is_premium() %}
                                    <span class="text-success">Unlimited</span>
                                {% else %}
                                    {{ current_user.credits_balance }} remaining
                                {% endif %}
                            </p>
                            {% if current_user.trial_ends_at and current_user.trial_ends_at > now %}
                            <p><strong>Trial:</strong> 
                                <span class="text-info">
                                    {{ (current_user.trial_ends_at - now).days }} days left
                                </span>
                            </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Usage Statistics -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Usage Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="stat-card">
                                <i class="fas fa-clipboard-list fa-2x text-primary mb-2"></i>
                                <h3>{{ monthly_usage }}</h3>
                                <p class="text-muted">Plans This Month</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <i class="fas fa-save fa-2x text-success mb-2"></i>
                                <h3>{{ saved_plans_count }}</h3>
                                <p class="text-muted">Saved Plans</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <i class="fas fa-fire fa-2x text-danger mb-2"></i>
                                <h3 id="totalCalories">0</h3>
                                <p class="text-muted">Calories Planned</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Upgrade CTA for Free Users -->
            {% if current_user.subscription_tier == 'free' %}
            <div class="card border-primary">
                <div class="card-body text-center">
                    <h4 class="text-primary">Unlock Unlimited Meal Plans!</h4>
                    <p>Upgrade to Pro and get:</p>
                    <div class="row justify-content-center mb-3">
                        <div class="col-auto">
                            <ul class="list-unstyled text-start">
                                <li><i class="fas fa-check text-success me-2"></i>Unlimited meal plans</li>
                                <li><i class="fas fa-check text-success me-2"></i>7-day meal planning</li>
                                <li><i class="fas fa-check text-success me-2"></i>PDF exports</li>
                                <li><i class="fas fa-check text-success me-2"></i>Priority support</li>
                            </ul>
                        </div>
                    </div>
                    <a href="{{ url_for('auth.upgrade') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-crown me-2"></i>Upgrade to Pro - $9.99/mo
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Saved Plans Modal -->
<div class="modal fade" id="savedPlansModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Your Saved Meal Plans</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="savedPlansList">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load user stats
    fetch('/auth/api/user/stats')
        .then(response => response.json())
        .then(data => {
            // Update any dynamic stats here
        });
    
    // View saved plans
    document.getElementById('viewSavedPlans').addEventListener('click', function(e) {
        e.preventDefault();
        const modal = new bootstrap.Modal(document.getElementById('savedPlansModal'));
        modal.show();
        
        // Load saved plans
        fetch('/api/load-meal-plans')
            .then(response => response.json())
            .then(data => {
                if (data.plans && data.plans.length > 0) {
                    let html = '<div class="list-group">';
                    data.plans.forEach(plan => {
                        html += `
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h6>${plan.name}</h6>
                                        <small class="text-muted">${plan.calories} cal Â· ${plan.diet_type}</small>
                                    </div>
                                    <button class="btn btn-sm btn-primary" onclick="loadPlan('${plan.filename}')">
                                        Load
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('savedPlansList').innerHTML = html;
                } else {
                    document.getElementById('savedPlansList').innerHTML = 
                        '<p class="text-center text-muted">No saved plans yet.</p>';
                }
            });
    });
});

function loadPlan(filename) {
    window.location.href = `/create?load=${filename}`;
}
</script>
{% endblock %}