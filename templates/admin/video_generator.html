{% extends "base.html" %}

{% block title %}Video Generator - Admin{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <h2><i class="fas fa-video me-2"></i>Content Video Generator</h2>
        </div>
        <div class="col text-end">
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Video Configuration</h5>
                </div>
                <div class="card-body">
                    <form id="videoGenForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="diet_type" class="form-label">Diet Type</label>
                                <select class="form-select" id="diet_type" name="diet_type" required>
                                    {% for diet in diet_types %}
                                    <option value="{{ diet }}">{{ diet.replace('_', ' ').title() }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="calories" class="form-label">Calories</label>
                                <input type="number" class="form-control" id="calories" name="calories" 
                                       value="2000" min="1200" max="4000" step="100" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="pattern" class="form-label">Meal Pattern</label>
                                <select class="form-select" id="pattern" name="pattern" required>
                                    {% for pattern in meal_patterns %}
                                    <option value="{{ pattern }}">{{ pattern.replace('_', ' ').title() }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="voice" class="form-label">Voice</label>
                                <select class="form-select" id="voice" name="voice">
                                    <option value="christopher" selected>Christopher (Male)</option>
                                    <option value="jenny">Jenny (Female)</option>
                                    <option value="ryan">Ryan (Male)</option>
                                    <option value="aria">Aria (Female)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Platforms</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="youtube_shorts" 
                                           name="platforms" value="youtube_shorts" checked>
                                    <label class="form-check-label" for="youtube_shorts">
                                        <i class="fab fa-youtube text-danger"></i> YouTube Shorts
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="tiktok" 
                                           name="platforms" value="tiktok">
                                    <label class="form-check-label" for="tiktok">
                                        <i class="fab fa-tiktok"></i> TikTok
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" id="instagram_reels" 
                                           name="platforms" value="instagram_reels">
                                    <label class="form-check-label" for="instagram_reels">
                                        <i class="fab fa-instagram text-purple"></i> Instagram Reels
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="auto_upload" name="auto_upload">
                                <label class="form-check-label" for="auto_upload">
                                    Auto-upload to platforms (requires API credentials)
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-magic me-2"></i>Generate Video
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">Quick Templates</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary template-btn" 
                                data-diet="keto" data-calories="1800">
                            Keto Weight Loss
                        </button>
                        <button class="btn btn-outline-primary template-btn" 
                                data-diet="vegan" data-calories="2500">
                            High Protein Vegan
                        </button>
                        <button class="btn btn-outline-primary template-btn" 
                                data-diet="mediterranean" data-calories="2000">
                            Mediterranean Heart Health
                        </button>
                        <button class="btn btn-outline-primary template-btn" 
                                data-diet="paleo" data-calories="2200">
                            Paleo Athletic
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Tips</h5>
                </div>
                <div class="card-body">
                    <ul class="small">
                        <li>Best times to post: 6-9 AM, 12-2 PM</li>
                        <li>Use trending hashtags for each platform</li>
                        <li>Keep videos under 60 seconds</li>
                        <li>High protein & keto perform best</li>
                        <li>Include "link in bio" CTA</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Section -->
    <div id="results" class="mt-4" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Generation Results</h5>
            </div>
            <div class="card-body" id="resultsContent">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Generating Video Content...</h5>
                <p class="text-muted mb-0">This may take 1-2 minutes</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('videoGenForm');
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    
    // Template buttons
    document.querySelectorAll('.template-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('diet_type').value = this.dataset.diet;
            document.getElementById('calories').value = this.dataset.calories;
        });
    });
    
    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const platforms = formData.getAll('platforms');
        
        const data = {
            diet_type: formData.get('diet_type'),
            calories: parseInt(formData.get('calories')),
            pattern: formData.get('pattern'),
            voice: formData.get('voice'),
            platforms: platforms,
            auto_upload: formData.has('auto_upload')
        };
        
        loadingModal.show();
        
        try {
            const response = await fetch('/admin/api/generate-content-video', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            loadingModal.hide();
            
            if (result.success) {
                displayResults(result.results);
            } else {
                alert('Error: ' + (result.error || 'Failed to generate video'));
            }
            
        } catch (error) {
            console.error('Error:', error);
            loadingModal.hide();
            alert('Error generating video: ' + error.message);
        }
    });
    
    function displayResults(results) {
        const resultsDiv = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');
        
        let html = '<div class="row">';
        
        // Display generation results
        for (const [platform, result] of Object.entries(results.generation)) {
            html += `
                <div class="col-md-4 mb-3">
                    <div class="card ${result.status === 'success' ? 'border-success' : 'border-danger'}">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="fas fa-${result.status === 'success' ? 'check-circle text-success' : 'times-circle text-danger'}"></i>
                                ${platform.replace('_', ' ').toUpperCase()}
                            </h6>
                            ${result.status === 'success' ? 
                                `<p class="small mb-1">Video: ${result.video_path}</p>
                                 <a href="/videos/${result.video_path.split('/').pop()}" class="btn btn-sm btn-primary" target="_blank">
                                    <i class="fas fa-play"></i> Watch
                                 </a>` :
                                `<p class="text-danger small">${result.error}</p>`
                            }
                        </div>
                    </div>
                </div>
            `;
        }
        
        html += '</div>';
        
        // Display upload results if any
        if (results.upload && Object.keys(results.upload).length > 0) {
            html += '<h6 class="mt-3">Upload Results:</h6><ul>';
            for (const [platform, status of Object.entries(results.upload)) {
                html += `<li>${platform}: ${status}</li>`;
            }
            html += '</ul>';
        }
        
        resultsContent.innerHTML = html;
        resultsDiv.style.display = 'block';
    }
});
</script>
{% endblock %}